<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل أعمدة الإنارة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .preview-image {
            max-width: 100%;
            height: 200px;
            object-fit: contain;
            margin: 10px 0;
            border: 1px dashed #ccc;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
        }
        .btn-success {
            background-color: #2ecc71;
            border-color: #2ecc71;
        }
        .form-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>نظام تسجيل أعمدة الإنارة</h1>
        
        <div class="step active" id="step1">
            <h3>الخطوة 1: إدخال رقم العمود</h3>
            <div class="mb-3">
                <label for="poleNumber" class="form-label">رقم العمود (5 أرقام)</label>
                <input type="text" class="form-control" id="poleNumber" pattern="\d{5}" required>
                <div class="invalid-feedback">يجب إدخال 5 أرقام فقط</div>
            </div>
            <button class="btn btn-primary" onclick="checkPole()">بحث/تسجيل جديد</button>
        </div>
        
        <div class="step" id="step2">
            <h3>الخطوة 2: تسجيل مراحل الإنجاز</h3>
            <div id="phaseButtons" class="d-flex flex-wrap justify-content-center">
                <button class="btn btn-outline-primary m-1" onclick="showPhase(1)">المرحلة الأولى</button>
                <button class="btn btn-outline-primary m-1" onclick="showPhase(2)">المرحلة الثانية</button>
                <button class="btn btn-outline-primary m-1" onclick="showPhase(3)">المرحلة الثالثة</button>
                <button class="btn btn-outline-primary m-1" onclick="showPhase(4)">المرحلة الرابعة</button>
            </div>
            
            <div id="phaseForms" class="mt-3">
                <!-- سيتم ملؤها ديناميكيًا -->
            </div>
            
            <div class="mt-3 text-center">
                <button class="btn btn-secondary me-2" onclick="backToStep1()">العودة</button>
                <button class="btn btn-success" id="exportBtn" style="display:none;" onclick="generatePDF()">تصدير PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal لعرض الصور -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">صورة العمود</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- الكود الرئيسي للتطبيق -->
    <script>
        // تكوين التطبيق
        const config = {
            imgbbApiKey: "YOUR_IMGBB_API_KEY", // استبدل بمفتاح API الخاص بك من ImgBB
            googleScriptUrl: "YOUR_GOOGLE_SCRIPT_URL" // استبدل برابط نشر سكريبت جوجل
        };

        const { jsPDF } = window.jspdf;

        // متغيرات التطبيق
        let currentPoleId = null;
        let currentPoleData = null;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));

        // التحقق من وجود عمود أو تسجيل جديد
        async function checkPole() {
            const poleNumber = document.getElementById('poleNumber').value;
            
            if (!/^\d{5}$/.test(poleNumber)) {
                document.getElementById('poleNumber').classList.add('is-invalid');
                return;
            }
            
            document.getElementById('poleNumber').classList.remove('is-invalid');
            currentPoleId = poleNumber;
            
            try {
                // البحث في جدول البيانات
                const response = await fetch(`${config.googleScriptUrl}?action=getPole&poleNumber=${poleNumber}`);
                
                if (!response.ok) {
                    throw new Error('فشل في الاتصال بالسيرفر');
                }
                
                const data = await response.json();
                
                if (data && data.poleNumber) {
                    currentPoleData = data;
                    showStep2();
                    updatePhaseButtons();
                } else {
                    // إنشاء سجل جديد
                    currentPoleData = {
                        poleNumber: poleNumber,
                        createdAt: new Date().toISOString()
                    };
                    
                    const saveResponse = await fetch(`${config.googleScriptUrl}?action=createPole`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(currentPoleData)
                    });
                    
                    if (!saveResponse.ok) {
                        throw new Error('فشل في إنشاء سجل جديد');
                    }
                    
                    const saveData = await saveResponse.json();
                    
                    if (saveData.success) {
                        showStep2();
                        updatePhaseButtons();
                    } else {
                        throw new Error('فشل في حفظ البيانات');
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                alert("حدث خطأ أثناء معالجة البيانات: " + error.message);
            }
        }

        // الانتقال إلى الخطوة 2
        function showStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }

        // العودة إلى الخطوة 1
        function backToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            document.getElementById('poleNumber').value = '';
            currentPoleId = null;
            currentPoleData = null;
        }

        // تحديث أزرار المراحل
        function updatePhaseButtons() {
            const phaseButtons = document.getElementById('phaseButtons');
            phaseButtons.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const phaseKey = `phase${i}`;
                const btn = document.createElement('button');
                btn.className = `btn m-1 ${currentPoleData[phaseKey] ? 'btn-success' : 'btn-outline-primary'}`;
                btn.textContent = `المرحلة ${i}`;
                btn.onclick = () => showPhase(i);
                phaseButtons.appendChild(btn);
            }
            
            // التحقق إذا كانت جميع المراحل مكتملة لعرض زر التصدير
            const allPhasesCompleted = [1,2,3,4].every(phase => currentPoleData[`phase${phase}`]);
            document.getElementById('exportBtn').style.display = allPhasesCompleted ? 'inline-block' : 'none';
        }

        // عرض نموذج المرحلة
        function showPhase(phaseNumber) {
            const phaseKey = `phase${phaseNumber}`;
            const phaseForms = document.getElementById('phaseForms');
            
            phaseForms.innerHTML = `
                <div class="card">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">المرحلة ${phaseNumber}</h4>
                    </div>
                    <div class="card-body">
                        ${currentPoleData[phaseKey] ? `
                            <div class="alert alert-success">تم تسجيل هذه المرحلة مسبقًا</div>
                            <div class="text-center">
                                <img src="${currentPoleData[`${phaseKey}Image`]}" class="preview-image img-thumbnail" onclick="showModalImage('${currentPoleData[`${phaseKey}Image`]}')">
                                <p class="text-muted mt-2">انقر على الصورة لتكبيرها</p>
                            </div>
                            <div class="mt-3">
                                <p><strong>تاريخ التسجيل:</strong> ${formatDate(currentPoleData[`${phaseKey}Date`])}</p>
                                <p><strong>ملاحظات:</strong> ${currentPoleData[`${phaseKey}Notes`] || 'لا توجد ملاحظات'}</p>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-warning" onclick="updatePhase(${phaseNumber})">تحديث البيانات</button>
                            </div>
                        ` : `
                            <form id="phaseForm${phaseNumber}" onsubmit="event.preventDefault(); savePhase(${phaseNumber});">
                                <div class="mb-3">
                                    <label for="phaseImage${phaseNumber}" class="form-label">صورة المرحلة</label>
                                    <input class="form-control" type="file" id="phaseImage${phaseNumber}" accept="image/*" capture="camera" required>
                                    <div class="preview-container mt-2 text-center"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="phaseNotes${phaseNumber}" class="form-label">ملاحظات</label>
                                    <textarea class="form-control" id="phaseNotes${phaseNumber}" rows="3"></textarea>
                                </div>
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">حفظ المرحلة</button>
                                    <button type="button" class="btn btn-secondary me-2" onclick="clearPhaseForm()">إلغاء</button>
                                </div>
                            </form>
                        `}
                    </div>
                </div>
            `;
            
            // إعداد معاينة الصورة
            const imageInput = document.getElementById(`phaseImage${phaseNumber}`);
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            alert('حجم الصورة يجب أن يكون أقل من 5MB');
                            e.target.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const previewContainer = imageInput.nextElementSibling;
                            previewContainer.innerHTML = `
                                <img src="${event.target.result}" class="preview-image img-thumbnail">
                                <p class="text-muted">معاينة الصورة</p>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return 'غير معروف';
            const date = new Date(dateString);
            return date.toLocaleString('ar-EG');
        }

        // حفظ بيانات المرحلة
        async function savePhase(phaseNumber) {
            const phaseKey = `phase${phaseNumber}`;
            const imageInput = document.getElementById(`phaseImage${phaseNumber}`);
            const notes = document.getElementById(`phaseNotes${phaseNumber}`).value;
            
            if (!imageInput || !imageInput.files[0]) {
                alert('يجب اختيار صورة للمرحلة');
                return;
            }
            
            try {
                // عرض مؤشر تحميل
                const submitBtn = document.querySelector(`#phaseForm${phaseNumber} [type="submit"]`);
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'جاري الحفظ...';
                submitBtn.disabled = true;
                
                // رفع الصورة إلى ImgBB
                const imageUrl = await uploadImageToImgBB(imageInput.files[0]);
                
                if (!imageUrl) {
                    throw new Error('فشل في رفع الصورة');
                }
                
                // تحضير بيانات المرحلة
                const phaseData = {
                    poleNumber: currentPoleId,
                    phaseNumber: phaseNumber,
                    imageUrl: imageUrl,
                    notes: notes,
                    date: new Date().toISOString()
                };
                
                // حفظ البيانات في Google Sheet
                const response = await fetch(`${config.googleScriptUrl}?action=savePhase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(phaseData)
                });
                
                if (!response.ok) {
                    throw new Error('فشل في حفظ البيانات');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // تحديث البيانات المحلية
                    currentPoleData[phaseKey] = true;
                    currentPoleData[`${phaseKey}Image`] = imageUrl;
                    currentPoleData[`${phaseKey}Notes`] = notes;
                    currentPoleData[`${phaseKey}Date`] = phaseData.date;
                    
                    alert('تم حفظ المرحلة بنجاح');
                    clearPhaseForm();
                    updatePhaseButtons();
                } else {
                    throw new Error(result.error || 'فشل في حفظ المرحلة');
                }
            } catch (error) {
                console.error("Error saving phase:", error);
                alert('حدث خطأ أثناء حفظ المرحلة: ' + error.message);
            } finally {
                // إعادة تعيين زر الحفظ
                const submitBtn = document.querySelector(`#phaseForm${phaseNumber} [type="submit"]`);
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        }

        // رفع الصورة إلى ImgBB
        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', config.imgbbApiKey);
            
            try {
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('فشل في رفع الصورة');
                }
                
                const data = await response.json();
                return data.data?.url || null;
            } catch (error) {
                console.error("Error uploading image:", error);
                throw error;
            }
        }

        // تحديث بيانات المرحلة
        function updatePhase(phaseNumber) {
            showPhase(phaseNumber);
        }

        // مسح نموذج المرحلة
        function clearPhaseForm() {
            document.getElementById('phaseForms').innerHTML = '';
        }

        // عرض الصورة في مودال
        function showModalImage(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            modal.show();
        }

        // إنشاء ملف PDF
        function generatePDF() {
            const doc = new jsPDF();
            
            // عنوان التقرير
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text(`تقرير عمود الإنارة رقم ${currentPoleId}`, 105, 15, null, null, 'center');
            
            // معلومات العمود
            doc.setFontSize(12);
            doc.text(`تاريخ الإنشاء: ${formatDate(currentPoleData.createdAt)}`, 14, 30);
            
            let yPosition = 50;
            
            // إضافة بيانات كل مرحلة
            for (let i = 1; i <= 4; i++) {
                const phaseKey = `phase${i}`;
                if (currentPoleData[phaseKey]) {
                    doc.setFontSize(14);
                    doc.setTextColor(30, 30, 30);
                    doc.text(`المرحلة ${i}`, 14, yPosition);
                    
                    doc.setFontSize(12);
                    doc.setTextColor(80, 80, 80);
                    doc.text(`تاريخ التسجيل: ${formatDate(currentPoleData[`${phaseKey}Date`])}`, 14, yPosition + 7);
                    doc.text(`ملاحظات: ${currentPoleData[`${phaseKey}Notes`] || 'لا توجد ملاحظات'}`, 14, yPosition + 14);
                    
                    yPosition += 25;
                }
            }
            
            // إضافة تذييل الصفحة
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text(`تم إنشاء التقرير في: ${new Date().toLocaleString('ar-EG')}`, 105, 285, null, null, 'center');
            
            // حفظ الملف
            doc.save(`تقرير_عمود_الإنارة_${currentPoleId}.pdf`);
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // يمكنك إضافة أي تهيئة إضافية هنا
            console.log('تم تحميل النظام بنجاح');
        });
    </script>
</body>
</html>
